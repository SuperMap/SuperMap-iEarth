import{a as T}from"./chunk-H6N4J6TN.js";import{a as y}from"./chunk-AMRCVYIA.js";import{a as b}from"./chunk-NPAFDOYL.js";import{a as p}from"./chunk-6S43R6PL.js";import{a as l}from"./chunk-6NA2GRXE.js";import{a as f}from"./chunk-UBHQMGET.js";import"./chunk-EDZQSM3T.js";import"./chunk-PJGSCWXZ.js";import{a as o}from"./chunk-NUC3LT2W.js";import"./chunk-SFC4FDPW.js";var v={CONNECTING:0,OPEN:1,CLOSING:2,CLOSED:3};function u(r,e,i){this._url=r,this._maximumActiveTasks=f(i.maximumActiveTasks,100),this._activeTasks=0,this._deferreds={},this._nextID=0,this._event=e,this._enableHeartCheck=f(i.enableHeartCheck,!1),this._heartTimeOut=f(i.heartTimeOut,1e4),this._createWS(e)}function g(r,e){if(e instanceof ArrayBuffer){--r._activeTasks;var i=new DataView(e),s=i.getInt32(0,!0);if(!o(s))return;var n=r._deferreds,t=n[s];if(o(t)){if(t.binaryType==="blob")e.byteLength===4?t.reject(404):t.resolve(new Blob([e.slice(4,e.byteLength)]));else if(t.binaryType==="arraybuffer")if(e.byteLength===4)t.reject(404);else{var a=e.slice(4,e.byteLength);t.extratiles?t.progress(a):t.resolve(a)}else{e=e.slice(4,e.byteLength);var x=new Uint8Array(e),h=T(x);if(t.binaryType==="json"){var c=JSON.parse(h);t.resolve(c)}else t.resolve(h)}t.extratiles!==!0&&delete n[s]}}}function k(r,e,i,s){var n;return e.indexOf("extratiles=")!==-1?(s.extratiles=!0,n={id:r,binaryType:f(i,"blob"),tileName:e.substring(0,e.indexOf("?")),extraTiles:e.substring(e.indexOf("extratiles=")+11)}):(s.extratiles=!1,n={id:r,binaryType:f(i,"blob"),tileName:e}),JSON.stringify(n)}u.prototype.scheduleTask=function(r,e){var i=this;if(!this.isOpened()){var t=l();return this._event.addEventListener(function(h){if(h===v.OPEN){++i._activeTasks;var c=i,_=c._nextID++;c._deferreds[_]=t,t.binaryType=e;var O=k(_,r,e,t);c._ws.send(O)}}),t.promise}if(!(this._activeTasks>=this._maximumActiveTasks)){++this._activeTasks;var s=this,n=s._nextID++,t=l();s._deferreds[n]=t,t.binaryType=e;var a=k(n,r,e,t);return s._ws.send(a),t.promise}};u.prototype._createWS=function(r){this._ws=new WebSocket(this._url),this._ws.binaryType="arraybuffer";var e=this;this._ws.onopen=function(){r.raiseEvent(v.OPEN)},this._ws.onclose=function(){r.raiseEvent(v.CLOSED)},this._ws.onerror=function(){error=new p("open failure"),r.raiseEvent(error)},this._ws.onmessage=function(i){g(e,i.data)}};u.prototype.isOpened=function(){return this._ws&&this._ws.readyState===v.OPEN};u.prototype.close=function(){this._ws.close()};var w=u;var m;function N(r,e){var i=r.data;if(i=="init")return m=new w(r.scpUrl,new b,{}),!0;var s=l(),n=r.dataType;if(o(m)){var t=m.scheduleTask(i,n);if(o(t))t.then(function(a){s.resolve(a)}).catch(function(a){s.reject(a)});else return t}return s.promise}var B=y(N);export{B as default};
