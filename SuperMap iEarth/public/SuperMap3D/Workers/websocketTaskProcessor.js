define(["./createTaskProcessorWorker","./defaultValue-2110bb17","./RuntimeError-6daf0e01","./getStringFromTypedArray-1f235117","./defer-a21481c0","./Event-589349b0","./Check-92c551fb"],(function(e,t,r,i,s,n,a){"use strict";var o,f=1,c=3;function u(e,r,i){this._url=e,this._maximumActiveTasks=t.u(i.maximumActiveTasks,100),this._activeTasks=0,this._deferreds={},this._nextID=0,this._event=r,this._enableHeartCheck=t.u(i.enableHeartCheck,!1),this._heartTimeOut=t.u(i.heartTimeOut,1e4),this._createWS(r)}function h(e,r,i,s){var n;return-1!==r.indexOf("extratiles=")?(s.extratiles=!0,n={id:e,binaryType:t.u(i,"blob"),tileName:r.substring(0,r.indexOf("?")),extraTiles:r.substring(r.indexOf("extratiles=")+11)}):(s.extratiles=!1,n={id:e,binaryType:t.u(i,"blob"),tileName:r}),JSON.stringify(n)}return u.prototype.scheduleTask=function(e,t){var r=this;if(!this.isOpened()){var i=s.s();return this._event.addEventListener((function(s){if(s===f){++r._activeTasks;var n=r,a=n._nextID++;n._deferreds[a]=i,i.binaryType=t;var o=h(a,e,t,i);n._ws.send(o)}})),i.promise}if(!(this._activeTasks>=this._maximumActiveTasks)){++this._activeTasks;var n=this,a=n._nextID++;i=s.s();n._deferreds[a]=i,i.binaryType=t;var o=h(a,e,t,i);return n._ws.send(o),i.promise}},u.prototype._createWS=function(e){this._ws=new WebSocket(this._url),this._ws.binaryType="arraybuffer";var s=this;this._ws.onopen=function(){e.raiseEvent(f)},this._ws.onclose=function(){e.raiseEvent(c)},this._ws.onerror=function(){error=new r.t("open failure"),e.raiseEvent(error)},this._ws.onmessage=function(e){!function(e,r){if(r instanceof ArrayBuffer){--e._activeTasks;var s=new DataView(r).getInt32(0,!0);if(!t.e(s))return;var n=e._deferreds,a=n[s];if(t.e(a)){if("blob"===a.binaryType)4===r.byteLength?a.reject(404):a.resolve(new Blob([r.slice(4,r.byteLength)]));else if("arraybuffer"===a.binaryType)if(4===r.byteLength)a.reject(404);else{var o=r.slice(4,r.byteLength);a.extratiles?a.progress(o):a.resolve(o)}else{r=r.slice(4,r.byteLength);var f=new Uint8Array(r),c=i.a(f);if("json"===a.binaryType){var u=JSON.parse(c);a.resolve(u)}else a.resolve(c)}!0!==a.extratiles&&delete n[s]}}}(s,e.data)}},u.prototype.isOpened=function(){return this._ws&&this._ws.readyState===f},u.prototype.close=function(){this._ws.close()},e((function(e,r){var i=e.data;if("init"==i)return o=new u(e.scpUrl,new n.o,{}),!0;var a=s.s(),f=e.dataType;if(t.e(o)){var c=o.scheduleTask(i,f);if(!t.e(c))return c;c.then((function(e){a.resolve(e)})).catch((function(e){a.reject(e)}))}return a.promise}))}));
