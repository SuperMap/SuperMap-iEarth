import{a as Qr,b as Zr}from"./chunk-K7EPBLTH.js";import{a as sr}from"./chunk-VZ2V43FJ.js";import{a as kr}from"./chunk-AMRCVYIA.js";import{a as Kr}from"./chunk-I6IKQZ7N.js";import{a as Jr}from"./chunk-HOZ5IOFP.js";import"./chunk-ZMHH4UFY.js";import"./chunk-6X6ULKRC.js";import"./chunk-MQMYX2JZ.js";import"./chunk-REXJO6A6.js";import"./chunk-EUSYH4JF.js";import{d as Dr,j as Gr}from"./chunk-CJHFPVIB.js";import"./chunk-NPAFDOYL.js";import{a as Z}from"./chunk-SSYG2MIY.js";import"./chunk-SRPTWKHW.js";import{a as Lr}from"./chunk-6S43R6PL.js";import"./chunk-Z4SOZDEW.js";import"./chunk-MX7ZM7WW.js";import"./chunk-EHDXVZQM.js";import{a as qr}from"./chunk-NLYLRNUA.js";import{a as pr,b as zr}from"./chunk-7TOCOFC3.js";import"./chunk-ZVKIUA3Y.js";import{b as N}from"./chunk-3HZNWEV7.js";import{a as w}from"./chunk-LBR6REQR.js";import{a}from"./chunk-GXFCHGTA.js";import{a as Yr}from"./chunk-UBHQMGET.js";import"./chunk-EDZQSM3T.js";import"./chunk-PJGSCWXZ.js";import{a as ur}from"./chunk-NUC3LT2W.js";import"./chunk-SFC4FDPW.js";var ht=Uint16Array.BYTES_PER_ELEMENT,hr=Int32Array.BYTES_PER_ELEMENT,Nr=Uint32Array.BYTES_PER_ELEMENT,ct=Float32Array.BYTES_PER_ELEMENT,U=Float64Array.BYTES_PER_ELEMENT;function $(e,m,r){r=Yr(r,a);for(var i=e.length,h=0;h<i;++h)if(r.equalsEpsilon(e[h],m,a.EPSILON12))return h;return-1}function vt(e,m){e.ellipsoid=zr.clone(e.ellipsoid),e.rectangle=qr.clone(e.rectangle);var r=gt(e.buffer,e.relativeToCenter,e.ellipsoid,e.rectangle,e.nativeRectangle,e.exaggeration,e.skirtHeight,e.includeWebMercatorT,e.negativeAltitudeExponentBias,e.negativeElevationThreshold),i=r.vertices;m.push(i.buffer);var h=r.indices;return m.push(h.buffer),{vertices:i.buffer,indices:h.buffer,numberOfAttributes:r.encoding.getStride(),minimumHeight:r.minimumHeight,maximumHeight:r.maximumHeight,boundingSphere3D:r.boundingSphere3D,orientedBoundingBox:r.orientedBoundingBox,occludeePointInScaledSpace:r.occludeePointInScaledSpace,encoding:r.encoding,vertexCountWithoutSkirts:r.vertexCountWithoutSkirts,indexCountWithoutSkirts:r.indexCountWithoutSkirts,westIndicesSouthToNorth:r.westIndicesSouthToNorth,southIndicesEastToWest:r.southIndicesEastToWest,eastIndicesNorthToSouth:r.eastIndicesNorthToSouth,northIndicesWestToEast:r.northIndicesWestToEast}}var u=new N,q=new w,dt=new w,mt=new w,ft=new Z;function gt(e,m,r,i,h,v,X,T,j,rr){var E,c,I,f,S,g;ur(i)?(E=i.west,c=i.south,I=i.east,f=i.north,S=i.width,g=i.height):(E=a.toRadians(h.west),c=a.toRadians(h.south),I=a.toRadians(h.east),f=a.toRadians(h.north),S=a.toRadians(i.width),g=a.toRadians(i.height));var D=[c,f],A=[E,I],b=Gr.eastNorthUpToFixedFrame(m,r),G=Z.inverseTransformation(b,ft),H,k;T&&(H=sr.geodeticLatitudeToMercatorAngle(c),k=1/(sr.geodeticLatitudeToMercatorAngle(f)-H));var o=new DataView(e),p=Number.POSITIVE_INFINITY,J=Number.NEGATIVE_INFINITY,P=dt;P.x=Number.POSITIVE_INFINITY,P.y=Number.POSITIVE_INFINITY,P.z=Number.POSITIVE_INFINITY;var _=mt;_.x=Number.NEGATIVE_INFINITY,_.y=Number.NEGATIVE_INFINITY,_.z=Number.NEGATIVE_INFINITY;var t=0,x=0,Tr=0,tr,V;for(V=0;V<4;++V){var l=t;tr=o.getUint32(l,!0),l+=Nr;var Sr=a.toRadians(o.getFloat64(l,!0)*180);l+=U,$(A,Sr)===-1&&A.push(Sr);var xr=a.toRadians(o.getFloat64(l,!0)*180);l+=U,$(D,xr)===-1&&D.push(xr),l+=2*U;var vr=o.getInt32(l,!0);l+=hr,x+=vr,vr=o.getInt32(l,!0),Tr+=vr*3,t+=tr+Nr}var Br=[],wr=[],d=new Array(x),y=new Array(x),R=new Array(x),F=T?new Array(x):[],M=new Array(Tr),O=[],er=[],ir=[],C=[],n=0,dr=0;for(t=0,V=0;V<4;++V){tr=o.getUint32(t,!0),t+=Nr;var $r=t,Xr=a.toRadians(o.getFloat64(t,!0)*180);t+=U;var jr=a.toRadians(o.getFloat64(t,!0)*180);t+=U;var Ar=a.toRadians(o.getFloat64(t,!0)*180),Pr=Ar*.5;t+=U;var _r=a.toRadians(o.getFloat64(t,!0)*180),yr=_r*.5;t+=U;var Rr=o.getInt32(t,!0);t+=hr;var rt=o.getInt32(t,!0);t+=hr,t+=hr;for(var mr=new Array(Rr),ar=0;ar<Rr;++ar){var K=Xr+o.getUint8(t++)*Ar;u.longitude=K;var Y=jr+o.getUint8(t++)*_r;u.latitude=Y;var B=o.getFloat32(t,!0);if(t+=ct,B!==0&&B<rr&&(B*=-Math.pow(2,j)),B*=6371010*v,u.height=B,$(A,K)!==-1||$(D,Y)!==-1){var Fr=$(Br,u,N);if(Fr===-1)Br.push(N.clone(u)),wr.push(n);else{mr[ar]=wr[Fr];continue}}mr[ar]=n,Math.abs(K-E)<Pr?O.push({index:n,cartographic:N.clone(u)}):Math.abs(K-I)<Pr?ir.push({index:n,cartographic:N.clone(u)}):Math.abs(Y-c)<yr?er.push({index:n,cartographic:N.clone(u)}):Math.abs(Y-f)<yr&&C.push({index:n,cartographic:N.clone(u)}),p=Math.min(B,p),J=Math.max(B,J),R[n]=B;var Mr=r.cartographicToCartesian(u);d[n]=Mr,T&&(F[n]=(sr.geodeticLatitudeToMercatorAngle(Y)-H)*k),Z.multiplyByPoint(G,Mr,q),w.minimumByComponent(q,P,P),w.maximumByComponent(q,_,_);var fr=(K-E)/(I-E);fr=a.clamp(fr,0,1);var gr=(Y-c)/(f-c);gr=a.clamp(gr,0,1),y[n]=new pr(fr,gr),++n}for(var tt=rt*3,Cr=0;Cr<tt;++Cr,++dr)M[dr]=mr[o.getUint16(t,!0)],t+=ht;if(tr!==t-$r)throw new Lr("Invalid terrain tile.")}d.length=n,y.length=n,R.length=n,T&&(F.length=n);var Wr=n,et=dr,Q={hMin:p,lastBorderPoint:void 0,skirtHeight:X,toENU:G,ellipsoid:r,minimum:P,maximum:_};O.sort(function(s,W){return W.cartographic.latitude-s.cartographic.latitude}),er.sort(function(s,W){return s.cartographic.longitude-W.cartographic.longitude}),ir.sort(function(s,W){return s.cartographic.latitude-W.cartographic.latitude}),C.sort(function(s,W){return W.cartographic.longitude-s.cartographic.longitude});var z=1e-5;if(cr(d,R,y,F,M,Q,O,-z*S,!0,-z*g),cr(d,R,y,F,M,Q,er,-z*g,!1),cr(d,R,y,F,M,Q,ir,z*S,!0,z*g),cr(d,R,y,F,M,Q,C,z*g,!1),O.length>0&&C.length>0){var it=O[0].index,Ur=Wr,br=C[C.length-1].index,at=d.length-1;M.push(br,at,Ur,Ur,it,br)}x=d.length;var ot=Dr.fromPoints(d),Hr;ur(i)&&(Hr=Kr.fromRectangle(i,p,J,r));for(var nt=new Qr(r),ut=nt.computeHorizonCullingPointPossiblyUnderEllipsoid(m,d,p),st=new Jr(P,_,m),lr=new Zr(st,Q.hMin,J,b,!1,T),Vr=new Float32Array(x*lr.getStride()),Or=0,L=0;L<x;++L)Or=lr.encode(Vr,Or,d[L],y[L],R[L],void 0,F[L]);var or=O.map(function(s){return s.index}).reverse(),Er=er.map(function(s){return s.index}).reverse(),nr=ir.map(function(s){return s.index}).reverse(),Ir=C.map(function(s){return s.index}).reverse();return Er.unshift(nr[nr.length-1]),Er.push(or[0]),Ir.unshift(or[or.length-1]),Ir.push(nr[0]),{vertices:Vr,indices:new Uint16Array(M),maximumHeight:J,minimumHeight:p,encoding:lr,boundingSphere3D:ot,orientedBoundingBox:Hr,occludeePointInScaledSpace:ut,vertexCountWithoutSkirts:Wr,indexCountWithoutSkirts:et,westIndicesSouthToNorth:or,southIndicesEastToWest:Er,eastIndicesNorthToSouth:nr,northIndicesWestToEast:Ir}}function cr(e,m,r,i,h,v,X,T,j,rr){for(var E=X.length,c=0;c<E;++c){var I=X[c],f=I.cartographic,S=I.index,g=e.length,D=f.longitude,A=f.latitude;A=a.clamp(A,-a.PI_OVER_TWO,a.PI_OVER_TWO);var b=f.height-v.skirtHeight;v.hMin=Math.min(v.hMin,b),N.fromRadians(D,A,b,u),j&&(u.longitude+=T),j?c===E-1?u.latitude+=rr:c===0&&(u.latitude-=rr):u.latitude+=T;var G=v.ellipsoid.cartographicToCartesian(u);e.push(G),m.push(b),r.push(pr.clone(r[S])),i.length>0&&i.push(i[S]),Z.multiplyByPoint(v.toENU,G,q);var H=v.minimum,k=v.maximum;w.minimumByComponent(q,H,H),w.maximumByComponent(q,k,k);var o=v.lastBorderPoint;if(ur(o)){var p=o.index;h.push(p,g-1,g,g,S,p)}v.lastBorderPoint=I}}var Wt=kr(vt);export{Wt as default};
